---
- name: Inject cloud tools vars
  include_vars:
    name: cloud_vars
    file: vars.yml

- name: Gather package facts
  package_facts:
    manager: auto

- name: Install terraform prereqs
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop: "{{ cloud_vars.prereqs }}"

- name: Install Terraform repo key
  get_url:
    url: https://apt.releases.hashicorp.com/gpg
    dest: /etc/apt/keyrings/hashicorp-archive-keyring.asc
    mode: "0644"
    force: yes

- name: Add Terraform to sources.list
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/hashicorp-archive-keyring.asc] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
    filename: terraform
    state: present
    update_cache: no

- name: Install Terraform
  apt:
    name: terraform
    state: present
    update_cache: yes

- name: Unarchive aws cli zip
  unarchive:
    src: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
    dest: /tmp
    remote_src: yes
  when: "{{ 'awscli' not in ansible_facts.packages }}"

- name: Install aws cli
  shell:
    cmd: /tmp/aws/install
  when: "{{ 'awscli' not in ansible_facts.packages }}"
